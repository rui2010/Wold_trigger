<html>
  <head>
    <script src="https://unpkg.com/three@0.147.0/build/three.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #myCanvas { display: block; background: #222; }
      #info {
        position: absolute; top: 10px; left: 10px; color: #fff; font-size: 16px;
        background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 6px;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div id="info">クリックでマウスキャプチャ / WASDで移動</div>
    <canvas id="myCanvas"></canvas>
    <script>
      window.addEventListener("DOMContentLoaded", init);
      function init() {
        // レンダラーを作成
        const canvasElement = document.querySelector('#myCanvas');
        const renderer = new THREE.WebGLRenderer({
          antialias: true,
          canvas: canvasElement,
        });

        // サイズ指定
        const width = window.innerWidth;
        const height = window.innerHeight;
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(width, height);

        // シーンを作成
        const scene = new THREE.Scene();

        // カメラを作成（FPS視点）
        const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        camera.position.set(0, 2, 5);

        // 地面
        const groundGeometry = new THREE.PlaneGeometry(100, 100);
        const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // ライト
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        // FPS移動用
        const move = { forward: false, backward: false, left: false, right: false };
        const speed = 0.1;

        window.addEventListener('keydown', (e) => {
          if (e.code === 'KeyW') move.forward = true;
          if (e.code === 'KeyS') move.backward = true;
          if (e.code === 'KeyA') move.left = true;
          if (e.code === 'KeyD') move.right = true;
        });
        window.addEventListener('keyup', (e) => {
          if (e.code === 'KeyW') move.forward = false;
          if (e.code === 'KeyS') move.backward = false;
          if (e.code === 'KeyA') move.left = false;
          if (e.code === 'KeyD') move.right = false;
        });

        // カメラの向き制御
        let yaw = 0;

        // PointerLockでマウスキャプチャ
        canvasElement.addEventListener('click', () => {
          canvasElement.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
          if (document.pointerLockElement === canvasElement) {
            document.addEventListener('mousemove', onMouseMove, false);
          } else {
            document.removeEventListener('mousemove', onMouseMove, false);
          }
        });

        function onMouseMove(e) {
          const sensitivity = 0.002;
          yaw -= e.movementX * sensitivity;
        }

        // アニメーションループ
        function animate() {
          requestAnimationFrame(animate);

          camera.rotation.set(0, yaw, 0);

          let direction = new THREE.Vector3();
          if (move.forward) direction.z -= 1;
          if (move.backward) direction.z += 1;
          if (move.left) direction.x -= 1;
          if (move.right) direction.x += 1;
          direction.normalize();
          if (direction.length() > 0) {
            const moveVector = new THREE.Vector3(direction.x, 0, direction.z);
            moveVector.applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
            camera.position.add(moveVector.multiplyScalar(speed));
          }

          renderer.render(scene, camera);
        }
        animate();
      }
    </script>
  </body>
</html>