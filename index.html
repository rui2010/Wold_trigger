<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>ワールドトリガー 3Dゲーム</title>
    <script src="https://unpkg.com/three@0.147.0/build/three.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: #222; }
      #info {
        position: absolute; top: 10px; left: 10px; color: #fff; font-size: 16px;
        background: rgba(0,0,0,0.5); padding: 6px 12px; border-radius: 6px;
        z-index: 10;
      }
      #startBtn, #triggerBtn, #charaBtn {
        font-size: 2rem; padding: 1em 2em; border-radius: 12px; border: none;
        background: #66cc66; color: #fff; cursor: pointer; margin: 0.5em;
      }
      #menu {
        position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
        display: flex; flex-direction: column; align-items: center; z-index: 100;
      }
      #opening {
        position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
        background: #000; color: #fff; display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; z-index: 2000; flex-direction: column;
        transition: opacity 1s;
      }
      #opening-logo {
        font-size: 3.5rem; font-weight: bold; letter-spacing: 0.2em; margin-bottom: 1em;
      }
      #opening-fade {
        opacity: 1; transition: opacity 1s;
      }
    </style>
  </head>
  <body>
    <div id="info" style="display:none;">
      WASD:移動 / スペース:ジャンプ / クリック:トリガー発射 / Shift:しゃがみ / マウス:視点<br>
      1:アステロイド 2:レイガスト 3:スコーピオン 4:イーグレット 5:バイパー 6:グラスホッパー<br>
      M:レーダー表示
    </div>
    <!-- オープニング -->
    <div id="opening">
      <div id="opening-logo">WORLD TRIGGER</div>
      <div id="opening-fade">ワールドトリガーへようこそ</div>
    </div>
    <!-- メニュー -->
    <div id="menu" style="display:none;">
      <button id="startBtn">ゲームスタート</button>
      <button id="triggerBtn">トリガー設定</button>
      <button id="charaBtn">キャラクター設定</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <!-- レーダー -->
    <canvas id="radar" width="180" height="180" style="position:absolute;right:20px;bottom:20px;z-index:50;display:none;background:rgba(0,0,0,0.7);border-radius:50%;"></canvas>
    <script>
      // --- オープニング演出 ---
      const opening = document.getElementById('opening');
      const openingFade = document.getElementById('opening-fade');
      const menu = document.getElementById('menu');
      const info = document.getElementById('info');
      const canvas = document.getElementById('gameCanvas');
      canvas.style.display = 'none';

      // オープニングアニメーション
      setTimeout(() => {
        openingFade.textContent = "BORDERシステム起動中...";
      }, 1200);
      setTimeout(() => {
        openingFade.textContent = "トリオン体構築完了";
      }, 2200);
      setTimeout(() => {
        openingFade.textContent = "ワールドトリガー ゲームへようこそ";
      }, 3200);
      setTimeout(() => {
        opening.style.opacity = 0;
      }, 4200);
      setTimeout(() => {
        opening.style.display = 'none';
        menu.style.display = '';
      }, 5200);

      // --- メニュー画面 ---
      let started = false;
      document.getElementById('startBtn').onclick = () => {
        menu.style.display = 'none';
        info.style.display = '';
        canvas.style.display = '';
        started = true;
        initGame();
      };
      document.getElementById('triggerBtn').onclick = () => {
        alert("トリガー設定は未実装です");
      };
      document.getElementById('charaBtn').onclick = () => {
        alert("キャラクター設定は未実装です");
      };

      // --- 基本セットアップ ---
      function initGame() {
        // --- THREE.jsセットアップ ---
        // const canvas = document.getElementById('gameCanvas'); ← ここは不要
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setClearColor(0x222222);
        renderer.setSize(window.innerWidth, window.innerHeight);

        const scene = new THREE.Scene();

        // カメラ
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);

        // ライト
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 10, 10);
        scene.add(light);

        // 地面
        const ground = new THREE.Mesh(
          new THREE.PlaneGeometry(100, 100),
          new THREE.MeshPhongMaterial({ color: 0x66cc66 })
        );
        ground.rotation.x = -Math.PI/2;
        scene.add(ground);

        // --- キャラクター（空閑遊真風） ---
        function createYuma() {
          const group = new THREE.Group();
          // 体
          const body = new THREE.Mesh(new THREE.BoxGeometry(0.9, 2, 0.6), new THREE.MeshPhongMaterial({ color: 0x00bfff }));
          body.position.y = 2;
          group.add(body);
          // 頭
          const head = new THREE.Mesh(new THREE.SphereGeometry(0.7, 20, 20), new THREE.MeshPhongMaterial({ color: 0xf8f8f8 }));
          head.position.y = 3.4;
          group.add(head);
          // 髪（前髪・サイド・後ろ）
          const hairMat = new THREE.MeshPhongMaterial({ color: 0xf8f8f8 });
          for (let i = 0; i < 3; i++) {
            const bang = new THREE.Mesh(new THREE.ConeGeometry(0.13, 0.45, 10), hairMat);
            bang.position.set(-0.18 + i * 0.18, 4.0, 0.55);
            bang.rotation.x = Math.PI / 1.7;
            group.add(bang);
          }
          for (let i = 0; i < 2; i++) {
            const side = new THREE.Mesh(new THREE.ConeGeometry(0.11, 0.38, 10), hairMat);
            side.position.set(i === 0 ? -0.38 : 0.38, 3.8, 0.38);
            side.rotation.x = Math.PI / 1.5;
            group.add(side);
          }
          for (let i = 0; i < 3; i++) {
            const back = new THREE.Mesh(new THREE.ConeGeometry(0.09, 0.32, 10), hairMat);
            back.position.set(-0.18 + i * 0.18, 3.7, -0.45);
            back.rotation.x = -Math.PI / 1.7;
            group.add(back);
          }
          // 目
          const eyeMat = new THREE.MeshBasicMaterial({ color: 0xff3333 });
          const leftEye = new THREE.Mesh(new THREE.SphereGeometry(0.09, 8, 8), eyeMat);
          leftEye.position.set(-0.16, 3.55, 0.62);
          group.add(leftEye);
          const rightEye = new THREE.Mesh(new THREE.SphereGeometry(0.09, 8, 8), eyeMat);
          rightEye.position.set(0.16, 3.55, 0.62);
          group.add(rightEye);
          // 口
          const mouth = new THREE.Mesh(new THREE.BoxGeometry(0.16, 0.03, 0.04), new THREE.MeshBasicMaterial({ color: 0x222222 }));
          mouth.position.set(0, 3.38, 0.63);
          group.add(mouth);
          // 両腕
          const rightArm = new THREE.Mesh(new THREE.CylinderGeometry(0.13, 0.13, 1.2, 12), new THREE.MeshPhongMaterial({ color: 0x00bfff }));
          rightArm.position.set(0.65, 2.3, 0);
          rightArm.rotation.z = Math.PI / 10;
          group.add(rightArm);
          const leftArm = new THREE.Mesh(new THREE.CylinderGeometry(0.13, 0.13, 1.2, 12), new THREE.MeshPhongMaterial({ color: 0x00bfff }));
          leftArm.position.set(-0.65, 2.3, 0);
          leftArm.rotation.z = -Math.PI / 10;
          group.add(leftArm);
          // 足
          const rightLeg = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1.2, 12), new THREE.MeshPhongMaterial({ color: 0x00bfff }));
          rightLeg.position.set(0.28, 0.6, 0);
          group.add(rightLeg);
          const leftLeg = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 1.2, 12), new THREE.MeshPhongMaterial({ color: 0x00bfff }));
          leftLeg.position.set(-0.28, 0.6, 0);
          group.add(leftLeg);
          return group;
        }
        const player = createYuma();
        scene.add(player);

        // --- プレイヤー状態 ---
        let playerPos = new THREE.Vector3(0, 2, 5);
        let playerVel = new THREE.Vector3(0, 0, 0);
        let isOnGround = false;
        let isCrouching = false;
        let yaw = 0, pitch = -0.18;
        let viewMode = 'fps';

        // --- 建物 ---
        for (let i = -2; i <= 2; i++) {
          for (let j = -2; j <= 2; j++) {
            if (i === 0 && j === 0) continue;
            const h = 10;
            const building = new THREE.Mesh(
              new THREE.BoxGeometry(4, h, 4),
              new THREE.MeshPhongMaterial({ color: 0xff0000, emissive: 0x660000, emissiveIntensity: 0.35 })
            );
            building.position.set(i * 14, h / 2, j * 14);
            scene.add(building);
          }
        }

        // --- 武器タイプ
        const WEAPON_ASTEROID = "asteroid";
        const WEAPON_RAYGUST = "raygust";
        const WEAPON_SCORPION = "scorpion";
        const WEAPON_EGRETS = "egret";
        const WEAPON_VIPER = "viper";
        const WEAPON_GRASSHOPPER = "grasshopper";
        let weaponType = WEAPON_ASTEROID;

        // 武器切り替え
        window.addEventListener('keydown', (e) => {
          if (e.code === 'Digit1') weaponType = WEAPON_ASTEROID;
          if (e.code === 'Digit2') weaponType = WEAPON_RAYGUST;
          if (e.code === 'Digit3') weaponType = WEAPON_SCORPION;
          if (e.code === 'Digit4') weaponType = WEAPON_EGRETS;
          if (e.code === 'Digit5') weaponType = WEAPON_VIPER;
          if (e.code === 'Digit6') weaponType = WEAPON_GRASSHOPPER;
        });

        // --- トリガー（武器）発射 ---
        const asteroidBullets = [];
        let canShoot = true;
        let isCharging = false;
        let chargeAsteroid = null;
        let chargeReady = false;
        let raygustMesh = null;
        let scorpionMesh = null;
        let grasshopperMesh = null;

        window.addEventListener('mousedown', (e) => {
          if (viewMode === 'fps' && !isCharging && canShoot && !chargeAsteroid) {
            isCharging = true;
            chargeReady = false;
            if (weaponType === WEAPON_ASTEROID) {
              // アステロイド
              const geo = new THREE.BoxGeometry(0.7, 0.7, 0.7);
              const mat = new THREE.MeshPhongMaterial({ color: 0x99ff66, emissive: 0x336633, emissiveIntensity: 0.5 });
              chargeAsteroid = new THREE.Mesh(geo, mat);
              scene.add(chargeAsteroid);
            } else if (weaponType === WEAPON_RAYGUST) {
              // レイガスト（盾）
              const geo = new THREE.BoxGeometry(0.5, 1.1, 0.15);
              const mat = new THREE.MeshPhongMaterial({ color: 0xccccff, emissive: 0x333366, emissiveIntensity: 0.7 });
              raygustMesh = new THREE.Mesh(geo, mat);
              scene.add(raygustMesh);
            } else if (weaponType === WEAPON_SCORPION) {
              // スコーピオン（刃）
              const geo = new THREE.BoxGeometry(0.1, 0.7, 0.18);
              const mat = new THREE.MeshPhongMaterial({ color: 0xff3333, emissive: 0x660000, emissiveIntensity: 0.7 });
              scorpionMesh = new THREE.Mesh(geo, mat);
              scene.add(scorpionMesh);
            } else if (weaponType === WEAPON_EGRETS) {
              // イーグレット（狙撃銃）
              const geo = new THREE.BoxGeometry(0.1, 0.1, 1.2);
              const mat = new THREE.MeshPhongMaterial({ color: 0x333333 });
              chargeAsteroid = new THREE.Mesh(geo, mat);
              scene.add(chargeAsteroid);
            } else if (weaponType === WEAPON_VIPER) {
              // バイパー（曲射弾：見た目はアステロイドと同じ）
              const geo = new THREE.BoxGeometry(0.7, 0.7, 0.7);
              const mat = new THREE.MeshPhongMaterial({ color: 0xffcc33, emissive: 0x664400, emissiveIntensity: 0.5 });
              chargeAsteroid = new THREE.Mesh(geo, mat);
              scene.add(chargeAsteroid);
            } else if (weaponType === WEAPON_GRASSHOPPER) {
              // グラスホッパー（ジャンプパネル）
              const geo = new THREE.BoxGeometry(0.6, 0.1, 0.6);
              const mat = new THREE.MeshPhongMaterial({ color: 0x33ff66, emissive: 0x006633, emissiveIntensity: 0.7 });
              grasshopperMesh = new THREE.Mesh(geo, mat);
              scene.add(grasshopperMesh);
            }
          }
        });
        window.addEventListener('mouseup', (e) => {
          if (!isCharging) return;
          if (weaponType === WEAPON_ASTEROID && chargeAsteroid) {
            if (!chargeReady) { chargeReady = true; return; }
            const dir = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation).normalize();
            asteroidBullets.push({
              mesh: chargeAsteroid,
              velocity: dir.multiplyScalar(0.7),
              alive: true
            });
            chargeAsteroid = null;
            isCharging = false;
            chargeReady = false;
            canShoot = false;
            setTimeout(() => { canShoot = true; }, 400);
          } else if (weaponType === WEAPON_RAYGUST && raygustMesh) {
            // レイガストは盾を前に出すだけ
            isCharging = false;
            setTimeout(() => {
              if (raygustMesh) {
                scene.remove(raygustMesh);
                raygustMesh = null;
              }
            }, 500);
          } else if (weaponType === WEAPON_SCORPION && scorpionMesh) {
            // スコーピオンは刃を一瞬出す
            isCharging = false;
            setTimeout(() => {
              if (scorpionMesh) {
                scene.remove(scorpionMesh);
                scorpionMesh = null;
              }
            }, 350);
          } else if (weaponType === WEAPON_EGRETS && chargeAsteroid) {
            // イーグレットは直線弾
            const dir = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation).normalize();
            asteroidBullets.push({
              mesh: chargeAsteroid,
              velocity: dir.multiplyScalar(2.0),
              alive: true
            });
            chargeAsteroid = null;
            isCharging = false;
            canShoot = false;
            setTimeout(() => { canShoot = true; }, 600);
          } else if (weaponType === WEAPON_VIPER && chargeAsteroid) {
            // バイパーは曲射
            const dir = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation).normalize();
            asteroidBullets.push({
              mesh: chargeAsteroid,
              velocity: dir.multiplyScalar(0.7),
              alive: true,
              viper: true,
              viperStep: 0
            });
            chargeAsteroid = null;
            isCharging = false;
            canShoot = false;
            setTimeout(() => { canShoot = true; }, 400);
          } else if (weaponType === WEAPON_GRASSHOPPER && grasshopperMesh) {
            // グラスホッパーはジャンプ
            isCharging = false;
            scene.remove(grasshopperMesh);
            grasshopperMesh = null;
            playerVel.y = 0.38;
          }
        });

        // --- 入力 ---
        const move = { forward: false, backward: false, left: false, right: false };
        let speed = 0.13;
        let gravity = -0.45;
        let jumpVel = 0.18;
        let wantJump = false;
        window.addEventListener('keydown', (e) => {
          if (e.code === 'KeyW') move.forward = true;
          if (e.code === 'KeyS') move.backward = true;
          if (e.code === 'KeyA') move.left = true;
          if (e.code === 'KeyD') move.right = true;
          if (e.code === 'Space') wantJump = true;
          if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') isCrouching = true;
        });
        window.addEventListener('keyup', (e) => {
          if (e.code === 'KeyW') move.forward = false;
          if (e.code === 'KeyS') move.backward = false;
          if (e.code === 'KeyA') move.left = false;
          if (e.code === 'KeyD') move.right = false;
          if (e.code === 'ShiftLeft' || e.code === 'ShiftRight') isCrouching = false;
        });
        canvas.addEventListener('click', () => {
          if (viewMode === 'fps') canvas.requestPointerLock();
        });
        document.addEventListener('pointerlockchange', () => {
          if (document.pointerLockElement === canvas) {
            document.addEventListener('mousemove', onMouseMove, false);
          } else {
            document.removeEventListener('mousemove', onMouseMove, false);
          }
        });
        function onMouseMove(e) {
          const sensitivity = 0.002;
          yaw -= e.movementX * sensitivity;
          pitch -= e.movementY * sensitivity;
          pitch = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, pitch));
        }

        // --- ゲームループ ---
        function animate() {
          requestAnimationFrame(animate);

          // キャラ位置
          player.position.set(playerPos.x, playerPos.y, playerPos.z);

          // カメラ
          if (viewMode === 'fps') {
            camera.position.copy(playerPos);
            camera.rotation.order = "YXZ";
            camera.rotation.y = yaw;
            camera.rotation.x = pitch;
            camera.rotation.z = 0;
          } else {
            // TPS未実装
          }

          // 移動
          let direction = new THREE.Vector3();
          if (move.forward) direction.z -= 1;
          if (move.backward) direction.z += 1;
          if (move.left) direction.x -= 1;
          if (move.right) direction.x += 1;
          direction.normalize();
          let moveVector = new THREE.Vector3();
          if (direction.length() > 0) {
            const forward = new THREE.Vector3(0, 0, -1).applyEuler(new THREE.Euler(pitch, yaw, 0, "YXZ"));
            const right = new THREE.Vector3(1, 0, 0).applyEuler(new THREE.Euler(0, yaw, 0, "YXZ"));
            moveVector = forward.multiplyScalar(direction.z).add(right.multiplyScalar(direction.x)).normalize();
          }
          // ジャンプ
          if (wantJump && isOnGround) {
            playerVel.y = jumpVel;
            isOnGround = false;
          }
          wantJump = false;
          // 重力
          playerVel.y += gravity * 0.5;
          // 移動速度
          playerVel.x = moveVector.x * speed;
          playerVel.z = moveVector.z * speed;
          // 位置更新
          playerPos.add(playerVel);
          // 地面
          if (playerPos.y < 1.0) {
            playerPos.y = 1.0;
            playerVel.y = 0;
            isOnGround = true;
          } else {
            isOnGround = false;
          }

          // 武器の手元表示
          if (viewMode === 'fps') {
            if (weaponType === WEAPON_ASTEROID && chargeAsteroid) {
              chargeAsteroid.visible = true;
              chargeAsteroid.position.copy(camera.position);
              const offset = new THREE.Vector3(0.0, -1.2, -1.5);
              offset.applyEuler(camera.rotation);
              chargeAsteroid.position.add(offset);
              chargeAsteroid.rotation.copy(camera.rotation);
            } else if (weaponType === WEAPON_RAYGUST && raygustMesh) {
              raygustMesh.visible = true;
              raygustMesh.position.copy(camera.position);
              const offset = new THREE.Vector3(0.5, -0.2, -1.0);
              offset.applyEuler(camera.rotation);
              raygustMesh.position.add(offset);
              raygustMesh.rotation.copy(camera.rotation);
            } else if (weaponType === WEAPON_SCORPION && scorpionMesh) {
              scorpionMesh.visible = true;
              scorpionMesh.position.copy(camera.position);
              const offset = new THREE.Vector3(0.4, -0.3, -1.0);
              offset.applyEuler(camera.rotation);
              scorpionMesh.position.add(offset);
              scorpionMesh.rotation.copy(camera.rotation);
            } else if (weaponType === WEAPON_EGRETS && chargeAsteroid) {
              chargeAsteroid.visible = true;
              chargeAsteroid.position.copy(camera.position);
              const offset = new THREE.Vector3(0.0, -0.7, -1.7);
              offset.applyEuler(camera.rotation);
              chargeAsteroid.position.add(offset);
              chargeAsteroid.rotation.copy(camera.rotation);
            } else if (weaponType === WEAPON_VIPER && chargeAsteroid) {
              chargeAsteroid.visible = true;
              chargeAsteroid.position.copy(camera.position);
              const offset = new THREE.Vector3(0.0, -1.2, -1.5);
              offset.applyEuler(camera.rotation);
              chargeAsteroid.position.add(offset);
              chargeAsteroid.rotation.copy(camera.rotation);
            } else if (weaponType === WEAPON_GRASSHOPPER && grasshopperMesh) {
              grasshopperMesh.visible = true;
              grasshopperMesh.position.copy(camera.position);
              const offset = new THREE.Vector3(0.0, -1.0, -1.2);
              offset.applyEuler(camera.rotation);
              grasshopperMesh.position.add(offset);
              grasshopperMesh.rotation.copy(camera.rotation);
            }
          }

          // アステロイド弾丸の移動
          for (const bullet of asteroidBullets) {
            if (!bullet.alive) continue;
            if (bullet.viper) {
              // バイパーは曲射
              bullet.mesh.position.add(bullet.velocity);
              bullet.viperStep = (bullet.viperStep || 0) + 1;
              // 途中でカーブ
              if (bullet.viperStep === 15) {
                bullet.velocity.x += (Math.random() - 0.5) * 0.7;
                bullet.velocity.y += (Math.random() - 0.5) * 0.2;
              }
            } else {
              bullet.mesh.position.add(bullet.velocity);
            }
            if (bullet.mesh.position.y < 0) {
              scene.remove(bullet.mesh);
              bullet.alive = false;
            }
          }

          // 手元のアステロイド
          if (viewMode === 'fps' && chargeAsteroid) {
            chargeAsteroid.visible = true;
            chargeAsteroid.position.copy(camera.position);
            const offset = new THREE.Vector3(0.0, -1.2, -1.5);
            offset.applyEuler(camera.rotation);
            chargeAsteroid.position.add(offset);
            chargeAsteroid.rotation.copy(camera.rotation);
          }

          // レーダー描画
          if (radarVisible) {
            radarCtx.clearRect(0, 0, radarCanvas.width, radarCanvas.height);
            // レーダー円
            radarCtx.save();
            radarCtx.globalAlpha = 0.7;
            radarCtx.beginPath();
            radarCtx.arc(90, 90, 85, 0, Math.PI * 2);
            radarCtx.fillStyle = "#222";
            radarCtx.fill();
            radarCtx.restore();
            // プレイヤー中心
            radarCtx.beginPath();
            radarCtx.arc(90, 90, 6, 0, Math.PI * 2);
            radarCtx.fillStyle = "#00bfff";
            radarCtx.fill();
            // 建物
            for (let i = -2; i <= 2; i++) {
              for (let j = -2; j <= 2; j++) {
                if (i === 0 && j === 0) continue;
                const bx = i * 14, bz = j * 14;
                const dx = bx - playerPos.x;
                const dz = bz - playerPos.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                if (dist > 60) continue;
                const angle = Math.atan2(dx, dz) - yaw;
                const r = dist * 2;
                const rx = 90 + Math.sin(angle) * r;
                const ry = 90 + Math.cos(angle) * r;
                radarCtx.beginPath();
                radarCtx.arc(rx, ry, 8, 0, Math.PI * 2);
                radarCtx.fillStyle = "#ff4444";
                radarCtx.fill();
              }
            }
            // 弾（アステロイド等）
            for (const bullet of asteroidBullets) {
              if (!bullet.alive) continue;
              const dx = bullet.mesh.position.x - playerPos.x;
              const dz = bullet.mesh.position.z - playerPos.z;
              const dist = Math.sqrt(dx*dx + dz*dz);
              if (dist > 60) continue;
              const angle = Math.atan2(dx, dz) - yaw;
              const r = dist * 2;
              const rx = 90 + Math.sin(angle) * r;
              const ry = 90 + Math.cos(angle) * r;
              radarCtx.beginPath();
              radarCtx.arc(rx, ry, 4, 0, Math.PI * 2);
              radarCtx.fillStyle = "#99ff66";
              radarCtx.fill();
            }
          }

          renderer.render(scene, camera);
        }
        animate();
      }
    </script>
  </body>
</html>
